{% extends "base.html" %}

{% block title %}Day {{ current_day }} Recovery Journal | Eyes of an Addict{% endblock %}

{% block content %}
<main class="container journal-container" id="journalContainer">
    <header style="text-align: center; margin: 2rem 0;">
        <h1>ğŸ“– Recovery Journal - Day {{ current_day }}</h1>
        <p>Your personal space for reflection, growth, and recovery</p>
        
        <!-- Progress indicator -->
        <div style="margin: 1rem 0;">
            <div style="background: #f0f0f0; border-radius: 10px; overflow: hidden; max-width: 300px; margin: 0 auto;">
                <div style="width: {{ entry.get_completion_percentage() }}%; background: linear-gradient(135deg, var(--recovery-green), var(--recovery-blue)); height: 8px; transition: width 0.3s ease;"></div>
            </div>
            <small id="completion-text">{{ entry.get_completion_percentage() }}% Complete</small>
        </div>
        
        <!-- Day navigation with swipe hints -->
        <div style="margin: 2rem 0; display: flex; justify-content: center; gap: 1rem; align-items: center; flex-wrap: wrap;">
            {% if current_day > 1 %}
                <button onclick="navigateToDay({{ current_day-1 }})" role="button" class="secondary" style="font-size: 0.9rem;">â† Day {{ current_day-1 }}</button>
            {% endif %}
            
            <select id="daySelector" onchange="navigateToDay(this.value)" style="padding: 0.5rem; border-radius: 0.3rem;">
                {% for i in range(1, 31) %}
                    <option value="{{ i }}" {% if i == current_day %}selected{% endif %}>Day {{ i }}</option>
                {% endfor %}
            </select>
            
            {% if current_day < 30 %}
                <button onclick="navigateToDay({{ current_day+1 }})" role="button" class="secondary" style="font-size: 0.9rem;">Day {{ current_day+1 }} â†’</button>
            {% endif %}
        </div>
        
        <div style="text-align: center; margin: 1rem 0; color: #666; font-size: 0.9rem;">
            ğŸ’¡ <strong>Swipe left/right</strong> to navigate between days | <strong>Touch & hold</strong> to draw
        </div>
        
        <!-- First-time user instructions -->
        {% if current_day == 1 and entry.get_completion_percentage() == 0 %}
        <div style="background: #e3f2fd; border-radius: 0.5rem; padding: 1.5rem; margin: 1rem 0; border-left: 4px solid var(--recovery-blue);">
            <h4 style="color: var(--recovery-blue); margin-bottom: 0.5rem;">ğŸ‘‹ Getting Started</h4>
            <p style="margin-bottom: 1rem; font-size: 0.9rem; line-height: 1.5;">Welcome to your interactive recovery journal! Here are a few quick tips:</p>
            <ul style="font-size: 0.9rem; line-height: 1.5; margin-left: 1rem;">
                <li>Take your time - there's no rush to complete everything at once</li>
                <li>Be honest with yourself - this is your safe space</li>
                <li>Your entries save automatically as you type</li>
                <li>Use the mode toggle above to switch between text and drawing</li>
                <li>Complete at least 50% to unlock the next day</li>
            </ul>
        </div>
        {% endif %}
    </header>

    <!-- Mode Toggle -->
    <div style="text-align: center; margin: 2rem 0;">
        <div class="mode-toggle" style="display: inline-flex; background: #f0f0f0; border-radius: 2rem; padding: 0.3rem;">
            <button type="button" id="textModeBtn" class="mode-btn active" onclick="switchMode('text')" style="padding: 0.5rem 1.5rem; border: none; border-radius: 1.5rem; background: var(--recovery-blue); color: white; cursor: pointer;">ğŸ“ Text Mode</button>
            <button type="button" id="drawModeBtn" class="mode-btn" onclick="switchMode('draw')" style="padding: 0.5rem 1.5rem; border: none; border-radius: 1.5rem; background: transparent; color: #666; cursor: pointer;">âœï¸ Draw Mode</button>
        </div>
    </div>

    <!-- Journal Form -->
    <form id="journalForm" style="max-width: 800px; margin: 0 auto;">
        <input type="hidden" name="day_number" value="{{ current_day }}">
        <input type="hidden" name="drawing_data" id="drawingDataInput" value="{{ entry.drawing_data or '' }}">
        
        <!-- Daily Reflection Section -->
        <section class="journal-section text-mode" style="margin: 3rem 0; padding: 2rem; background: #f8f9fa; border-radius: 0.5rem;">
            <h2 style="color: var(--recovery-blue); margin-bottom: 1rem;">ğŸ’­ Daily Reflection</h2>
            <label for="daily_reflection">How are you feeling today? What's on your mind about your recovery journey?</label>
            <div class="input-container">
                <textarea name="daily_reflection" id="daily_reflection" rows="6" 
                          placeholder="Take your time to reflect on your day, your feelings, and your recovery progress..."
                          style="width: 100%; margin: 0.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 0.3rem;">{{ entry.daily_reflection or '' }}</textarea>
                <canvas class="drawing-canvas" id="reflectionCanvas" width="760" height="200" style="display: none; border: 2px dashed #ddd; border-radius: 0.3rem; cursor: crosshair; margin: 0.5rem 0;"></canvas>
            </div>
        </section>
        
        <!-- Free Drawing Section (Draw Mode Only) -->
        <section class="journal-section draw-mode" style="margin: 3rem 0; padding: 2rem; background: #fff; border-radius: 0.5rem; border: 2px solid #e0e0e0; display: none;">
            <h2 style="color: var(--recovery-purple); margin-bottom: 1rem;">ğŸ¨ Free Drawing & Notes</h2>
            <p style="margin-bottom: 1rem; color: #666;">Use your finger or stylus to draw, sketch, or write freely</p>
            <div style="text-align: center; margin-bottom: 1rem;">
                <button type="button" onclick="clearCanvas('mainCanvas')" style="padding: 0.5rem 1rem; background: #ff6b6b; color: white; border: none; border-radius: 0.3rem; margin-right: 1rem;">ğŸ—‘ï¸ Clear</button>
                <button type="button" onclick="changeDrawingColor('#000000')" style="padding: 0.5rem 1rem; background: #000; color: white; border: none; border-radius: 0.3rem; margin: 0 0.25rem;">âš«</button>
                <button type="button" onclick="changeDrawingColor('#2E8B57')" style="padding: 0.5rem 1rem; background: #2E8B57; color: white; border: none; border-radius: 0.3rem; margin: 0 0.25rem;">ğŸŸ¢</button>
                <button type="button" onclick="changeDrawingColor('#4169E1')" style="padding: 0.5rem 1rem; background: #4169E1; color: white; border: none; border-radius: 0.3rem; margin: 0 0.25rem;">ğŸ”µ</button>
                <button type="button" onclick="changeDrawingColor('#9370DB')" style="padding: 0.5rem 1rem; background: #9370DB; color: white; border: none; border-radius: 0.3rem; margin: 0 0.25rem;">ğŸŸ£</button>
            </div>
            <canvas id="mainCanvas" width="760" height="400" style="border: 2px solid #ddd; border-radius: 0.3rem; cursor: crosshair; display: block; margin: 0 auto; background: white; touch-action: none;"></canvas>
        </section>

        <!-- Gratitude Section -->
        <section style="margin: 3rem 0; padding: 2rem; background: #fff3cd; border-radius: 0.5rem;">
            <h2 style="color: var(--recovery-green); margin-bottom: 1rem;">ğŸ™ Daily Gratitude</h2>
            <label for="gratitude_items">What are 3 things you're grateful for today?</label>
            <textarea name="gratitude_items" id="gratitude_items" rows="4" 
                      placeholder="1. &#10;2. &#10;3. &#10;&#10;Big or small, every bit of gratitude counts..."
                      style="width: 100%; margin: 0.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 0.3rem;">{{ entry.gratitude_items or '' }}</textarea>
        </section>

        <!-- Challenges & Wins Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 3rem 0;">
            <!-- Challenges -->
            <section style="padding: 2rem; background: #ffe6e6; border-radius: 0.5rem;">
                <h3 style="color: var(--recovery-orange); margin-bottom: 1rem;">âš¡ Today's Challenges</h3>
                <label for="challenges_faced">What challenges did you face today?</label>
                <textarea name="challenges_faced" id="challenges_faced" rows="4" 
                          placeholder="Be honest about your struggles - they're part of the journey..."
                          style="width: 100%; margin: 0.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 0.3rem;">{{ entry.challenges_faced or '' }}</textarea>
            </section>

            <!-- Wins -->
            <section style="padding: 2rem; background: #e6ffe6; border-radius: 0.5rem;">
                <h3 style="color: var(--recovery-green); margin-bottom: 1rem;">ğŸ† Today's Wins</h3>
                <label for="wins_celebrations">What victories can you celebrate today?</label>
                <textarea name="wins_celebrations" id="wins_celebrations" rows="4" 
                          placeholder="No win is too small to celebrate - every step counts..."
                          style="width: 100%; margin: 0.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 0.3rem;">{{ entry.wins_celebrations or '' }}</textarea>
            </section>
        </div>

        <!-- Mood & Wellness Tracking -->
        <section style="margin: 3rem 0; padding: 2rem; background: #f0f8ff; border-radius: 0.5rem;">
            <h2 style="color: var(--recovery-purple); margin-bottom: 1rem;">ğŸ“Š Wellness Check-In</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                <!-- Mood Rating -->
                <div>
                    <label for="mood_rating">Overall Mood (1-10)</label>
                    <input type="range" name="mood_rating" id="mood_rating" min="1" max="10" 
                           value="{{ entry.mood_rating or 5 }}" 
                           oninput="updateSliderValue('mood_rating', this.value)"
                           style="width: 100%; margin: 0.5rem 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                        <span>ğŸ˜¢ Low</span>
                        <span id="mood_rating_value">{{ entry.mood_rating or 5 }}</span>
                        <span>ğŸ˜Š High</span>
                    </div>
                </div>

                <!-- Energy Level -->
                <div>
                    <label for="energy_level">Energy Level (1-10)</label>
                    <input type="range" name="energy_level" id="energy_level" min="1" max="10" 
                           value="{{ entry.energy_level or 5 }}" 
                           oninput="updateSliderValue('energy_level', this.value)"
                           style="width: 100%; margin: 0.5rem 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                        <span>ğŸ”‹ Drained</span>
                        <span id="energy_level_value">{{ entry.energy_level or 5 }}</span>
                        <span>âš¡ Energized</span>
                    </div>
                </div>

                <!-- Sleep Quality -->
                <div>
                    <label for="sleep_quality">Sleep Quality (1-10)</label>
                    <input type="range" name="sleep_quality" id="sleep_quality" min="1" max="10" 
                           value="{{ entry.sleep_quality or 5 }}" 
                           oninput="updateSliderValue('sleep_quality', this.value)"
                           style="width: 100%; margin: 0.5rem 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                        <span>ğŸ˜´ Poor</span>
                        <span id="sleep_quality_value">{{ entry.sleep_quality or 5 }}</span>
                        <span>ğŸŒ™ Excellent</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recovery Tools Section -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin: 3rem 0;">
            <!-- Triggers & Coping -->
            <section style="padding: 2rem; background: #fff0f5; border-radius: 0.5rem;">
                <h3 style="color: var(--recovery-purple); margin-bottom: 1rem;">ğŸ§  Trigger Awareness</h3>
                <label for="trigger_notes">What triggers did you notice today? How did you handle them?</label>
                <textarea name="trigger_notes" id="trigger_notes" rows="4" 
                          placeholder="Awareness is the first step to management..."
                          style="width: 100%; margin: 0.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 0.3rem;">{{ entry.trigger_notes or '' }}</textarea>
            </section>

            <!-- Coping Strategies -->
            <section style="padding: 2rem; background: #f0fff0; border-radius: 0.5rem;">
                <h3 style="color: var(--recovery-green); margin-bottom: 1rem;">ğŸ› ï¸ Coping Strategies</h3>
                <label for="coping_strategies">What healthy coping strategies did you use today?</label>
                <textarea name="coping_strategies" id="coping_strategies" rows="4" 
                          placeholder="Exercise, meditation, calling a friend, deep breathing..."
                          style="width: 100%; margin: 0.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 0.3rem;">{{ entry.coping_strategies or '' }}</textarea>
            </section>
        </div>

        <!-- Support & Future Planning -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 3rem 0;">
            <!-- Support Connections -->
            <section style="padding: 2rem; background: #f5f5ff; border-radius: 0.5rem;">
                <h3 style="color: var(--recovery-blue); margin-bottom: 1rem;">ğŸ¤ Support Connections</h3>
                <label for="support_connections">Who did you connect with today? How did they support you?</label>
                <textarea name="support_connections" id="support_connections" rows="4" 
                          placeholder="Family, friends, support groups, therapists, sponsors..."
                          style="width: 100%; margin: 0.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 0.3rem;">{{ entry.support_connections or '' }}</textarea>
            </section>

            <!-- Tomorrow's Goals -->
            <section style="padding: 2rem; background: #fffacd; border-radius: 0.5rem;">
                <h3 style="color: var(--recovery-orange); margin-bottom: 1rem;">ğŸ¯ Tomorrow's Goals</h3>
                <label for="goals_tomorrow">What are your goals for tomorrow?</label>
                <textarea name="goals_tomorrow" id="goals_tomorrow" rows="4" 
                          placeholder="Set 1-3 realistic, achievable goals for tomorrow..."
                          style="width: 100%; margin: 0.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 0.3rem;">{{ entry.goals_tomorrow or '' }}</textarea>
            </section>
        </div>

        <!-- Save & Navigation Actions -->
        <section style="text-align: center; margin: 4rem 0; padding: 2rem; background: #f8f9fa; border-radius: 0.5rem;">
            <div id="save-status" style="margin-bottom: 1rem; font-weight: bold;"></div>
            
            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                <button type="button" onclick="saveEntry()" role="button" style="background: var(--recovery-green); color: white; border: none;">
                    ğŸ’¾ Save Progress
                </button>
                <a href="{{ url_for('dashboard') }}" role="button" class="secondary">
                    ğŸ  Back to Dashboard
                </a>
                <a href="{{ url_for('journal_pdf') }}" role="button" class="secondary" target="_blank">
                    ğŸ“„ View PDF Guide
                </a>
            </div>
            
            <div style="margin-top: 2rem;">
                <small style="color: #666;">
                    ğŸ’¡ Your journal entries are automatically saved as you type. 
                    Take your time and be honest with yourself - this is your safe space.
                </small>
            </div>
        </section>
    </form>

    <!-- Quick Progress Overview -->
    <section style="margin: 4rem 0; padding: 2rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 0.5rem;">
        <h3 style="text-align: center; margin-bottom: 2rem;">ğŸ“ˆ Your 30-Day Progress</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 0.5rem; max-width: 600px; margin: 0 auto;">
            {% for day_entry in all_entries %}
                <div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;
                           {% if day_entry.completed %}
                               background: var(--recovery-green); color: white;
                           {% elif day_entry.day_number == current_day %}
                               background: var(--recovery-blue); color: white;
                           {% else %}
                               background: #f0f0f0; color: #666;
                           {% endif %}">
                    {{ day_entry.day_number }}
                </div>
            {% endfor %}
        </div>
        <div style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: #666;">
            <span style="color: var(--recovery-green);">â— Completed</span> | 
            <span style="color: var(--recovery-blue);">â— Current</span> | 
            <span style="color: #666;">â— Upcoming</span>
        </div>
    </section>
</main>

<style>
/* Auto-save indicator */
.save-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 0.5rem 1rem;
    border-radius: 0.3rem;
    font-size: 0.9rem;
    z-index: 1000;
    transition: all 0.3s ease;
}

.save-indicator.saving {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.save-indicator.saved {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.save-indicator.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* Enhanced form styling */
textarea {
    resize: vertical;
    font-family: inherit;
    transition: border-color 0.3s ease;
}

textarea:focus {
    border-color: var(--recovery-blue) !important;
    outline: none;
    box-shadow: 0 0 0 2px rgba(65, 105, 225, 0.2);
}

/* Slider styling */
input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    border-radius: 4px;
    background: #ddd;
    outline: none;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--recovery-blue);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--recovery-blue);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style>

<script>
let saveTimeout;
let isAutoSaving = false;
let currentMode = 'text';
let isDrawing = false;
let currentColor = '#000000';
let lastX = 0;
let lastY = 0;

// Touch/Swipe variables
let startX = 0;
let startY = 0;
let isSwipeDetected = false;

// Canvas references
let canvases = {};

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    setupSwipeHandlers();
    setupDrawingCanvases();
    loadDrawingData();
});

function initializeApp() {
    const inputs = document.querySelectorAll('#journalForm textarea, #journalForm input');
    inputs.forEach(input => {
        input.addEventListener('input', autoSave);
    });
}

// Mode switching between text and draw
function switchMode(mode) {
    currentMode = mode;
    
    const textModeBtn = document.getElementById('textModeBtn');
    const drawModeBtn = document.getElementById('drawModeBtn');
    const textSections = document.querySelectorAll('.text-mode');
    const drawSections = document.querySelectorAll('.draw-mode');
    
    if (mode === 'text') {
        textModeBtn.style.background = 'var(--recovery-blue)';
        textModeBtn.style.color = 'white';
        drawModeBtn.style.background = 'transparent';
        drawModeBtn.style.color = '#666';
        
        textSections.forEach(section => section.style.display = 'block');
        drawSections.forEach(section => section.style.display = 'none');
    } else {
        drawModeBtn.style.background = 'var(--recovery-purple)';
        drawModeBtn.style.color = 'white';
        textModeBtn.style.background = 'transparent';
        textModeBtn.style.color = '#666';
        
        textSections.forEach(section => section.style.display = 'none');
        drawSections.forEach(section => section.style.display = 'block');
    }
}

// Setup swipe handlers
function setupSwipeHandlers() {
    const container = document.getElementById('journalContainer');
    
    // Touch events
    container.addEventListener('touchstart', handleTouchStart, { passive: false });
    container.addEventListener('touchmove', handleTouchMove, { passive: false });
    container.addEventListener('touchend', handleTouchEnd, { passive: false });
    
    // Mouse events for desktop testing
    container.addEventListener('mousedown', handleMouseStart);
    container.addEventListener('mousemove', handleMouseMove);
    container.addEventListener('mouseup', handleMouseEnd);
}

function handleTouchStart(e) {
    if (e.target.tagName === 'CANVAS') return; // Don't interfere with canvas drawing
    
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    isSwipeDetected = false;
}

function handleTouchMove(e) {
    if (e.target.tagName === 'CANVAS') return;
    
    if (!startX || !startY) return;
    
    const currentX = e.touches[0].clientX;
    const currentY = e.touches[0].clientY;
    
    const diffX = startX - currentX;
    const diffY = startY - currentY;
    
    // Check if horizontal swipe is dominant
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        isSwipeDetected = true;
        e.preventDefault(); // Prevent scrolling
    }
}

function handleTouchEnd(e) {
    if (e.target.tagName === 'CANVAS') return;
    if (!isSwipeDetected) return;
    
    const currentDay = {{ current_day }};
    const endX = e.changedTouches[0].clientX;
    const diffX = startX - endX;
    
    if (Math.abs(diffX) > 100) { // Minimum swipe distance
        if (diffX > 0 && currentDay < 30) {
            // Swipe left - next day
            navigateToDay(currentDay + 1);
        } else if (diffX < 0 && currentDay > 1) {
            // Swipe right - previous day
            navigateToDay(currentDay - 1);
        }
    }
    
    startX = 0;
    startY = 0;
    isSwipeDetected = false;
}

// Mouse equivalents for desktop
function handleMouseStart(e) {
    if (e.target.tagName === 'CANVAS') return;
    startX = e.clientX;
    startY = e.clientY;
}

function handleMouseMove(e) {
    if (e.target.tagName === 'CANVAS') return;
    if (!startX) return;
    
    const diffX = startX - e.clientX;
    if (Math.abs(diffX) > 50) {
        isSwipeDetected = true;
    }
}

function handleMouseEnd(e) {
    if (e.target.tagName === 'CANVAS') return;
    if (!isSwipeDetected) return;
    
    const currentDay = {{ current_day }};
    const diffX = startX - e.clientX;
    
    if (Math.abs(diffX) > 100) {
        if (diffX > 0 && currentDay < 30) {
            navigateToDay(currentDay + 1);
        } else if (diffX < 0 && currentDay > 1) {
            navigateToDay(currentDay - 1);
        }
    }
    
    startX = 0;
    isSwipeDetected = false;
}

// Canvas drawing setup
function setupDrawingCanvases() {
    const canvasElements = document.querySelectorAll('canvas');
    
    canvasElements.forEach(canvas => {
        const ctx = canvas.getContext('2d');
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 3;
        ctx.strokeStyle = currentColor;
        
        canvases[canvas.id] = { canvas, ctx };
        
        // Touch events for drawing
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        
        // Mouse events for drawing
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
    });
}

function startDrawing(e) {
    e.preventDefault();
    isDrawing = true;
    
    const rect = e.target.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    
    lastX = x;
    lastY = y;
}

function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    
    const canvas = e.target;
    const ctx = canvases[canvas.id].ctx;
    const rect = canvas.getBoundingClientRect();
    
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    
    lastX = x;
    lastY = y;
    
    // Auto-save canvas data
    saveCanvasData();
}

function stopDrawing() {
    isDrawing = false;
}

function clearCanvas(canvasId) {
    const canvasData = canvases[canvasId];
    if (canvasData) {
        canvasData.ctx.clearRect(0, 0, canvasData.canvas.width, canvasData.canvas.height);
        saveCanvasData();
    }
}

function changeDrawingColor(color) {
    currentColor = color;
    Object.values(canvases).forEach(({ ctx }) => {
        ctx.strokeStyle = color;
    });
}

function saveCanvasData() {
    const mainCanvas = document.getElementById('mainCanvas');
    if (mainCanvas) {
        const drawingData = mainCanvas.toDataURL();
        document.getElementById('drawingDataInput').value = drawingData;
        autoSave();
    }
}

function loadDrawingData() {
    const drawingData = document.getElementById('drawingDataInput').value;
    if (drawingData) {
        const mainCanvas = document.getElementById('mainCanvas');
        const ctx = mainCanvas.getContext('2d');
        const img = new Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0);
        };
        img.src = drawingData;
    }
}

// Auto-save functionality
function autoSave() {
    if (isAutoSaving) return;
    
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        saveEntry(true); // Silent auto-save
    }, 2000); // Save 2 seconds after user stops typing
}

// Save journal entry
function saveEntry(silent = false) {
    if (isAutoSaving && silent) return;
    
    isAutoSaving = true;
    const formData = new FormData(document.getElementById('journalForm'));
    
    if (!silent) {
        showSaveIndicator('saving', 'ğŸ’¾ Saving...');
    }
    
    fetch('/save-journal-entry', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (!silent) {
                showSaveIndicator('saved', 'âœ… Saved!');
                document.getElementById('save-status').innerHTML = 
                    `<span style="color: var(--recovery-green);">${data.message}</span>`;
            }
            
            // Update completion percentage
            updateCompletionBar(data.completion_percentage);
            
            // Update save indicator briefly
            if (silent) {
                showSaveIndicator('saved', 'ğŸ’¾ Auto-saved', 1000);
            }
        } else {
            showSaveIndicator('error', 'âŒ Save failed');
            document.getElementById('save-status').innerHTML = 
                `<span style="color: #dc3545;">Error: ${data.error}</span>`;
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        showSaveIndicator('error', 'âŒ Save failed');
        document.getElementById('save-status').innerHTML = 
            `<span style="color: #dc3545;">Error saving entry. Please try again.</span>`;
    })
    .finally(() => {
        isAutoSaving = false;
    });
}

// Show save indicator
function showSaveIndicator(type, message, duration = 3000) {
    let indicator = document.getElementById('save-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'save-indicator';
        indicator.className = 'save-indicator';
        document.body.appendChild(indicator);
    }
    
    indicator.className = `save-indicator ${type}`;
    indicator.textContent = message;
    indicator.style.display = 'block';
    
    setTimeout(() => {
        indicator.style.display = 'none';
    }, duration);
}

// Update completion progress bar
function updateCompletionBar(percentage) {
    const progressBar = document.querySelector('[style*="width:"]');
    const progressText = document.getElementById('completion-text');
    
    if (progressBar) {
        progressBar.style.width = percentage + '%';
    }
    if (progressText) {
        progressText.textContent = percentage + '% Complete';
    }
}

// Update slider values
function updateSliderValue(sliderId, value) {
    document.getElementById(sliderId + '_value').textContent = value;
}

// Navigate to different day
function navigateToDay(day) {
    // Save current state before navigating
    if (currentMode === 'draw') {
        saveCanvasData();
    }
    saveEntry(true);
    
    setTimeout(() => {
        window.location.href = `/recovery-journal?day=${day}`;
    }, 500);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
    // Ctrl+S to save
    if (event.ctrlKey && event.key === 's') {
        event.preventDefault();
        saveEntry();
    }
    
    // Arrow keys for navigation
    if (event.key === 'ArrowLeft' && {{ current_day }} > 1) {
        navigateToDay({{ current_day }} - 1);
    } else if (event.key === 'ArrowRight' && {{ current_day }} < 30) {
        navigateToDay({{ current_day }} + 1);
    }
});
</script>
{% endblock %}